@model List<TrainMonitor.web.Models.Home.HomePageViewModel>
@{
    ViewData["Title"] = "Home Page";
}

<div class="container mt-4">
    <h1 class="mb-4 text-center">🚆 Train Monitor Dashboard</h1>

    <div class="row g-3" id="trainsContainer">
        @if (Model != null && Model.Any())
        {
            foreach (var t in Model)
            {
                <div class="col-md-4" id="train-@t.Id">
                    <div class="card p-3 border-start border-5 
                        @(t.DelayMinutes == 0 ? "border-success" 
                        : t.DelayMinutes < 10 ? "border-warning" 
                        : "border-danger")">

                        <!-- 🔹 Secțiunea generală (nu se schimbă live) -->
                        <div class="mb-2">
                            <h5>@t.Name (@t.TrainNumber)</h5>
                            <p class="text-muted mb-1">
                                <strong>Route:</strong> @t.Name
                            </p>
                        </div>

                        <hr />

                        <!-- 🔸 Secțiunea live (actualizată prin SignalR) -->
                        <div class="live-section">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="train-delay fw-bold text-@(t.DelayMinutes == 0 ? "success" : t.DelayMinutes < 10 ? "warning" : "danger")">
                                    @(t.DelayMinutes == 0 ? "ON TIME" : $"{t.DelayMinutes} min delay")
                                </span>
                            </div>

                            <p class="train-nextStop mb-1">
                                <strong>Next stop:</strong> @t.NextStop
                            </p>

                            <p class="train-lastUpdated mb-0">
                                <small>Last updated: @t.LastUpdated.ToString("HH:mm:ss")</small>
                            </p>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center text-muted">
                <p>No trains available at the moment.</p>
            </div>
        }
    </div>
</div>

<!-- SignalR script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
<script>
const connection = new signalR.HubConnectionBuilder()
    .withUrl("/trainHub")
    .build();

// 🔁 Actualizare live
connection.on("ReceiveTrainUpdate", (trains) => {
    trains.forEach(train => {
        const cardWrapper = document.getElementById(`train-${train.id}`);
        if (cardWrapper) {
            const delaySpan = cardWrapper.querySelector(".train-delay");
            const nextStopP = cardWrapper.querySelector(".train-nextStop");
            const lastUpdatedP = cardWrapper.querySelector(".train-lastUpdated");
            const cardDiv = cardWrapper.querySelector(".card");

            // actualizează doar valorile dinamice
            if (delaySpan) {
                delaySpan.textContent = train.delayMinutes === 0 ? "ON TIME" : `${train.delayMinutes} min delay`;
                delaySpan.className = `train-delay fw-bold text-${train.delayMinutes === 0 ? "success" : train.delayMinutes < 10 ? "warning" : "danger"}`;
            }

            if (nextStopP) {
                nextStopP.innerHTML = `<strong>Next stop:</strong> ${train.nextStop}`;
            }

            if (lastUpdatedP) {
                lastUpdatedP.innerHTML = `<small>Last updated: ${new Date(train.lastUpdated).toLocaleTimeString()}</small>`;
            }

            if (cardDiv) {
                cardDiv.className = `card p-3 border-start border-5 ${train.delayMinutes === 0 ? "border-success" : train.delayMinutes < 10 ? "border-warning" : "border-danger"}`;
            }
        } else {
            // dacă e un tren nou, îl adăugăm complet
            const container = document.getElementById("trainsContainer");
            const newCardWrapper = document.createElement("div");
            newCardWrapper.className = "col-md-4";
            newCardWrapper.id = `train-${train.id}`;
            newCardWrapper.innerHTML = `
                <div class="card p-3 border-start border-5 ${train.delayMinutes === 0 ? "border-success" : train.delayMinutes < 10 ? "border-warning" : "border-danger"}">
                    <div class="mb-2">
                        <h5>${train.name} (${train.trainNumber})</h5>
                        <p class="text-muted mb-1"><strong>Route:</strong> ${train.route}</p>
                    </div>
                    <hr/>
                    <div class="live-section">
                        <span class="train-delay fw-bold text-${train.delayMinutes === 0 ? "success" : train.delayMinutes < 10 ? "warning" : "danger"}">
                            ${train.delayMinutes === 0 ? "ON TIME" : train.delayMinutes + " min delay"}
                        </span>
                        <p class="train-nextStop mb-1"><strong>Next stop:</strong> ${train.nextStop}</p>
                        <p class="train-lastUpdated mb-0"><small>Last updated: ${new Date(train.lastUpdated).toLocaleTimeString()}</small></p>
                    </div>
                </div>`;
            container.appendChild(newCardWrapper);
        }
    });
});

connection.start()
    .then(() => console.log("Connected to SignalR"))
    .catch(err => console.error(err));
</script>
